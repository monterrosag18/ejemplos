# ------------------------------------------------------------
# Importamos librer√≠as necesarias
# ------------------------------------------------------------
import csv   # Para leer y escribir archivos CSV
import os    # Para comprobar existencia y eliminar archivos

# ------------------------------------------------------------
# FUNCI√ìN: Crear un archivo CSV con datos iniciales
# ------------------------------------------------------------
def crear_csv(nombre_archivo):
    """
    Crea un archivo CSV nuevo con encabezados y datos iniciales.
    Validaci√≥n: si el archivo ya existe, no lo sobrescribe autom√°ticamente.
    """
    if os.path.exists(nombre_archivo):
        print(f"‚ö†Ô∏è El archivo '{nombre_archivo}' ya existe. No se cre√≥ uno nuevo.")
        return

    with open(nombre_archivo, mode="w", newline="", encoding="utf-8") as archivo:
        escritor = csv.writer(archivo)
        escritor.writerow(["id", "nombre", "edad"])  # Encabezados
        escritor.writerow([1, "Carlos", 25])
        escritor.writerow([2, "Ana", 30])
        escritor.writerow([3, "Luis", 28])
    print(f"‚úÖ Archivo '{nombre_archivo}' creado con datos iniciales.")


# ------------------------------------------------------------
# FUNCI√ìN: Agregar un nuevo registro
# ------------------------------------------------------------
def agregar_registro(nombre_archivo, id, nombre, edad):
    """
    A√±ade un nuevo registro al CSV.
    Validaciones:
    - El archivo debe existir.
    - El ID no debe estar repetido.
    - La edad debe ser un n√∫mero entero positivo.
    """
    if not os.path.exists(nombre_archivo):
        print("‚ùå No se puede agregar registro: el archivo no existe.")
        return

    # Validaci√≥n de edad
    if not isinstance(edad, int) or edad <= 0:
        print("‚ùå Edad inv√°lida. Debe ser un n√∫mero entero positivo.")
        return

    # Leer registros existentes para validar ID
    with open(nombre_archivo, mode="r", encoding="utf-8") as archivo:
        lector = csv.reader(archivo)
        filas = list(lector)

    # Comprobar si el ID ya existe
    for fila in filas[1:]:  # Saltamos encabezados
        if fila[0] == str(id):
            print(f"‚ùå El ID {id} ya existe. No se agreg√≥ el registro.")
            return

    # Si pasa validaciones, agregamos el registro
    with open(nombre_archivo, mode="a", newline="", encoding="utf-8") as archivo:
        escritor = csv.writer(archivo)
        escritor.writerow([id, nombre, edad])
    print(f"‚ûï Registro agregado: {id}, {nombre}, {edad}")


# ------------------------------------------------------------
# FUNCI√ìN: Leer archivo CSV
# ------------------------------------------------------------
def leer_csv(nombre_archivo):
    """
    Muestra el contenido del archivo CSV.
    Validaci√≥n: el archivo debe existir y no estar vac√≠o.
    """
    if not os.path.exists(nombre_archivo):
        print("‚ùå No se puede leer: el archivo no existe.")
        return

    with open(nombre_archivo, mode="r", encoding="utf-8") as archivo:
        lector = csv.reader(archivo)
        filas = list(lector)

        if len(filas) == 0:
            print("‚ö†Ô∏è El archivo est√° vac√≠o.")
            return

        for fila in filas:
            print(fila)


# ------------------------------------------------------------
# FUNCI√ìN: Actualizar registro
# ------------------------------------------------------------
def actualizar_registro(nombre_archivo, id_objetivo, nuevo_nombre, nueva_edad):
    """
    Actualiza un registro existente.
    Validaciones:
    - El archivo debe existir.
    - El ID debe estar presente.
    - La nueva edad debe ser v√°lida.
    """
    if not os.path.exists(nombre_archivo):
        print("‚ùå No se puede actualizar: el archivo no existe.")
        return

    if not isinstance(nueva_edad, int) or nueva_edad <= 0:
        print("‚ùå Edad inv√°lida. Debe ser un n√∫mero entero positivo.")
        return

    with open(nombre_archivo, mode="r", encoding="utf-8") as archivo:
        lector = csv.reader(archivo)
        filas = list(lector)

    encontrado = False
    for fila in filas:
        if fila[0] == str(id_objetivo):
            fila[1] = nuevo_nombre
            fila[2] = str(nueva_edad)
            encontrado = True

    if not encontrado:
        print(f"‚ùå No se encontr√≥ un registro con id={id_objetivo}.")
        return

    with open(nombre_archivo, mode="w", newline="", encoding="utf-8") as archivo:
        escritor = csv.writer(archivo)
        escritor.writerows(filas)

    print(f"‚úèÔ∏è Registro con id={id_objetivo} actualizado a: {nuevo_nombre}, {nueva_edad}")


# ------------------------------------------------------------
# FUNCI√ìN: Eliminar registro
# ------------------------------------------------------------
def eliminar_registro(nombre_archivo, id_objetivo):
    """
    Elimina un registro por ID.
    Validaciones:
    - El archivo debe existir.
    - El ID debe estar presente.
    """
    if not os.path.exists(nombre_archivo):
        print("‚ùå No se puede eliminar: el archivo no existe.")
        return

    with open(nombre_archivo, mode="r", encoding="utf-8") as archivo:
        lector = csv.reader(archivo)
        filas = list(lector)

    nuevas_filas = [fila for fila in filas if fila[0] != str(id_objetivo)]

    if len(nuevas_filas) == len(filas):
        print(f"‚ùå No se encontr√≥ un registro con id={id_objetivo}.")
        return

    with open(nombre_archivo, mode="w", newline="", encoding="utf-8") as archivo:
        escritor = csv.writer(archivo)
        escritor.writerows(nuevas_filas)

    print(f"üóëÔ∏è Registro con id={id_objetivo} eliminado.")


# ------------------------------------------------------------
# FUNCI√ìN: Eliminar archivo completo
# ------------------------------------------------------------
def eliminar_archivo(nombre_archivo):
    """
    Elimina el archivo CSV completo.
    Validaci√≥n: el archivo debe existir.
    """
    if os.path.exists(nombre_archivo):
        os.remove(nombre_archivo)
        print(f"üóëÔ∏è Archivo '{nombre_archivo}' eliminado.")
    else:
        print("‚ùå No se puede eliminar: el archivo no existe.")


# ------------------------------------------------------------
# DEMO DEL CRUD CON VALIDACIONES
# ------------------------------------------------------------
nombre = "personas.csv"

crear_csv(nombre)                     # Crear archivo inicial
agregar_registro(nombre, 4, "Marta", 22)  # Agregar registro v√°lido
agregar_registro(nombre, 2, "Pedro", 40)  # Intento con ID duplicado
agregar_registro(nombre, 5, "Juan", -10)  # Intento con edad inv√°lida

print("\nüìñ Leyendo archivo:")
leer_csv(nombre)

actualizar_registro(nombre, 2, "Andrea", 31)  # Actualizar registro v√°lido
actualizar_registro(nombre, 99, "X", 20)      # Intento con ID inexistente

print("\nüìñ Leyendo archivo tras actualizaci√≥n:")
leer_csv(nombre)

eliminar_registro(nombre, 3)          # Eliminar registro v√°lido
eliminar_registro(nombre, 99)         # Intento con ID inexistente

print("\nüìñ Leyendo archivo tras eliminaci√≥n:")
leer_csv(nombre)

# eliminar_archivo(nombre)            # Eliminar archivo completo (descomenta para probar)
